

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>KIC 10080943 &mdash; maelstrom 0.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Maelstrom" href="../api/maelstrom.html" />
    <link rel="prev" title="KIC 6780873" href="6780873.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> maelstrom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/citation.html">Citing</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Getting started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Estimating frequencies.html">Choosing the correct frequencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Custom priors.html">Custom priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/Recovering weak signals.html">Recovering weak signals</a></li>
</ul>
<p class="caption"><span class="caption-text">Case studies from paper</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="9651065.html">KIC 9651065</a></li>
<li class="toctree-l1"><a class="reference internal" href="6780873.html">KIC 6780873</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">KIC 10080943</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Subdividing">Subdividing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#RV-only">RV only</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Maelstrom">Maelstrom</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Maelstrom-+-RV">Maelstrom + RV</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/maelstrom.html">Maelstrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/orbit.html">Orbit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/periodogram.html">Periodogram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/utils.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/estimator.html">Estimator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/eddy.html">Eddy</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">maelstrom</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>KIC 10080943</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/case_studies/10080943.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="KIC-10080943">
<h1>KIC 10080943<a class="headerlink" href="#KIC-10080943" title="Permalink to this headline">¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>%run setup.py
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>t, y = np.loadtxt(&#39;../data/10080943_lc.txt&#39;, usecols=(0,1)).T
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>plt.plot(t,y)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x1c2316def0&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_3_1.png" src="../_images/case_studies_10080943_3_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from scipy.ndimage import gaussian_filter
from maelstrom.utils import amplitude_spectrum
y_low = gaussian_filter(y,1.8)
y_high = y - y_low

plt.plot(*amplitude_spectrum(t, y), alpha=0.5)
plt.plot(*amplitude_spectrum(t, y_high), alpha=0.5)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: AstropyDeprecationWarning: Importing LombScargle from astropy.stats has been deprecated and will no longer be supported in future. Please import this class from the astropy.timeseries module instead [astropy.stats.lombscargle]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x1c238d4e48&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_4_2.png" src="../_images/case_studies_10080943_4_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>ms = Maelstrom(t, y_high, freq=np.array([13.94758557, 15.68333011,
                                    12.45257641,
#                                     12.89053954,
                                    17.30504092,
#                                     14.20333404
                                   ]))
ms.first_look(segment_size=5)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&lt;matplotlib.axes._subplots.AxesSubplot object at 0x11a6adb70&gt;,
       &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1c238f7cf8&gt;,
       &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1c23a5c2e8&gt;,
       &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1c23a8e898&gt;],
      dtype=object)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_5_1.png" src="../_images/case_studies_10080943_5_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>freq = ms.freq
time, flux = ms.time, ms.flux
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>period_guess = 15.334
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def get_phase(nu, t, y):
    arg = 2*np.pi*nu[None, :]*t[:, None]
    D = np.concatenate((np.sin(arg), np.cos(arg),
                        np.ones((len(t), 1))), axis=1)
    DT = D.T
    DTD = np.dot(DT, D)
    w = np.linalg.solve(DTD, np.dot(D.T, y))
    return np.arctan2(w[:len(nu)], w[len(nu):2*len(nu)]) / (2*np.pi*nu)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import tqdm
t0s = np.arange(time.min(), time.max(), 3.5)
phases = np.empty((len(t0s)-1, len(freq)))
phases[:] = np.nan
for i, t0 in tqdm.tqdm(enumerate(t0s[:-1]), total=len(t0s)-1):
    m = (t0 &lt;= time) &amp; (time &lt; t0s[i+1])
    if m.sum() &lt; 100:
        continue
    phases[i] = get_phase(freq, time[m], flux[m])

# phases -= np.nanmean(phases, axis=0)
full = np.mean(phases, axis=1)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 420/420 [00:00&lt;00:00, 3232.91it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>m = np.isfinite(phases[:, 0])
res = xo.estimators.lomb_scargle_estimator(t0s[:-1][m], phases[m, 0], min_period=12, max_period=25)
f, p = res[&quot;periodogram&quot;]
plt.plot(1 / f, p)
plt.axvline(res[&quot;peaks&quot;][0][&quot;period&quot;], color=&quot;k&quot;)
plt.xlabel(&quot;period&quot;)
plt.ylabel(&quot;power&quot;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;power&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_10_1.png" src="../_images/case_studies_10080943_10_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>period_guess = res[&quot;peaks&quot;][0][&quot;period&quot;]
arg = 2*np.pi*t0s[:-1][m]/period_guess
D = np.concatenate((np.sin(arg)[:, None],
                    np.cos(arg)[:, None],
                    np.ones((len(phases[m]), 1))), axis=-1)
w = np.linalg.solve(np.dot(D.T, D), np.dot(D.T, phases[m, 0]))
a_guess = np.sqrt(np.sum(w[:2]**2)) * 86400
period_guess, a_guess
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(15.335878873082686, 43.18400031048696)
</pre></div></div>
</div>
<div class="section" id="Subdividing">
<h2>Subdividing<a class="headerlink" href="#Subdividing" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>def dft_phase(x, y, freq):
    freq = np.asarray(freq)
    x = np.array(x)
    y = np.array(y)
    phase = []
    for f in freq:
        expo = 2.0 * np.pi * f * x
        ft_real = np.sum(y * np.cos(expo))
        ft_imag = np.sum(y * np.sin(expo))
        phase.append(np.arctan2(ft_imag,ft_real))
    return phase
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from astropy.stats import LombScargle

freq = ms.freq[:1]
segment_size=4

uHz_conv = 1e-6 * 24 * 60 * 60
time_0 = time[0]
time_slice, mag_slice, phase = [], [], []
time_delays, time_midpoints = [], []

# Iterate over lightcurve
for t, y in zip(time, flux):
    time_slice.append(t)
    mag_slice.append(y)

    # In each segment
    if t - time_0 &gt; segment_size:
        # Append the time midpoint
        time_midpoints.append(np.mean(time_slice))

        # And the phases for each frequency
        phase.append(dft_phase(time_slice, mag_slice, freq))
        time_0 = t
        time_slice, mag_slice = [], []

phase = np.array(phase).T
# Phase wrapping patch
for ph, f in zip(phase, freq):
    mean_phase = np.mean(ph)
    ph[np.where(ph - mean_phase &gt; np.pi/2)] -= np.pi
    ph[np.where(ph - mean_phase &lt; -np.pi/2)] += np.pi
    ph -= np.mean(ph)
#     ph = np.unwrap(ph)
#     ph -= np.mean(ph)

    td = ph / (2*np.pi*(f / uHz_conv * 1e-6))
    time_delays.append(td)

weights = ms.get_weights(norm=False)


#|plt.scatter(time_midpoints,np.average(time_delays,axis=0, weights=weights))

td_time, td_td = time_midpoints,np.average(time_delays,axis=0, weights=weights[:1])
#nu_arr = freq
td_time = np.array(td_time)
td_td = np.array(td_td)
# td_time, td_td = np.array(time_midpoints), np.array(time_delays[0])

</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>weights
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([1.34772162, 1.24429097, 0.91763563, 0.61523976])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import theano.tensor as tt

with pm.Model() as subdivide_model:
    logP = pm.Normal(&quot;logP&quot;, mu=np.log(period_guess), sd=1.0, testval=np.log(period_guess))
    period = pm.Deterministic(&quot;period&quot;, pm.math.exp(logP))
    mean = pm.Normal(&#39;mean&#39;, mu=np.median(td_td), sd=5, testval=np.median(td_td))
    # The time of conjunction
    phi = xo.distributions.Angle(&quot;phi&quot;)
    logs_lc = pm.Normal(&#39;logs_lc&#39;, mu=np.log(np.std(flux)), sd=10, testval=0.)
    logasini = pm.Normal(&#39;logasini&#39;, mu=np.log(a_guess), sd=5, testval=np.log(a_guess))
    asini = pm.Deterministic(&quot;asini&quot;, tt.exp(logasini))
    #drift = pm.Normal(&#39;drift&#39;, mu=0., sd=0.1, testval=0)
    # Periastron sampled from uniform angle
    omega = xo.distributions.Angle(&quot;omega&quot;, testval=0.)
    # Eccentricity
    eccen = pm.Uniform(&quot;eccen&quot;, lower=0, upper=0.9, testval=0.4)

    # Mean anom
    M = 2.0 * np.pi * td_time / period - phi

    # True anom
    kepler_op = xo.theano_ops.kepler.KeplerOp()
    sinf, cosf = kepler_op(M, eccen + np.zeros(len(td_time)))

    factor = 1.0 - tt.square(eccen)
    factor /= 1.0 + eccen * cosf
    psi = factor * (sinf*tt.cos(omega)+cosf*tt.sin(omega))
    tau = asini * psi
    #tau += td_time * drift
    taumodel = pm.Deterministic(&#39;taumodel&#39;, tau - tt.mean(tau) + mean)

    pm.Normal(&#39;obs&#39;, mu=taumodel, sd=tt.exp(logs_lc), observed=td_td)

    plt.plot(td_time, xo.eval_in_model(taumodel))
    plt.scatter(td_time, td_td)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_16_0.png" src="../_images/case_studies_10080943_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with subdivide_model:
    map_params = xo.optimize(vars=[mean])
    map_params = xo.optimize(start=map_params, vars=[logP])
    map_params = xo.optimize(start=map_params, vars=[logasini])
    map_params = xo.optimize(start=map_params, vars=[omega, eccen])
    map_params = xo.optimize(start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
optimizing logp for variables: [mean]
5it [00:01,  2.80it/s, logp=-1.276811e+06]
message: Optimization terminated successfully.
logp: -1277151.0054081937 -&gt; -1276810.5971639934
optimizing logp for variables: [logP]
13it [00:00, 88.30it/s, logp=-9.719662e+05]
message: Optimization terminated successfully.
logp: -1276810.5971639934 -&gt; -971966.1627903979
optimizing logp for variables: [logasini]
16it [00:00, 83.34it/s, logp=-8.544680e+05]
message: Optimization terminated successfully.
logp: -971966.1627903979 -&gt; -854468.0445354239
optimizing logp for variables: [eccen, omega]
137it [00:00, 282.98it/s, logp=-8.541406e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -854468.0445354239 -&gt; -854140.5739847843
optimizing logp for variables: [eccen, omega, logasini, logs_lc, phi, mean, logP]
21it [00:00, 116.03it/s, logp=-1.021591e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -854140.5739847843 -&gt; -114780.21445976157
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with subdivide_model:
    trace = pm.sample(draws=2000, tune=2000, chains=2)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [eccen, omega, logasini, logs_lc, phi, mean, logP]
Sampling 2 chains: 100%|██████████| 8000/8000 [12:15&lt;00:00, 10.88draws/s]
The acceptance probability does not match the target. It is 0.9187384576573221, but should be close to 0.8. Try to increase the number of tuning steps.
There were 130 divergences after tuning. Increase `target_accept` or reparameterize.
The acceptance probability does not match the target. It is 0.16236133349742451, but should be close to 0.8. Try to increase the number of tuning steps.
The chain reached the maximum tree depth. Increase max_treedepth, increase target_accept or reparameterize.
The gelman-rubin statistic is larger than 1.4 for some parameters. The sampler did not converge.
The estimated number of effective samples is smaller than 200 for some parameters.
</pre></div></div>
</div>
</div>
<div class="section" id="RV-only">
<h2>RV only<a class="headerlink" href="#RV-only" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_jd_a, rv_rv_a, rv_err_a = np.loadtxt(&#39;../../data/kic10080943a_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_a += 2400000
rv_jd_a -= 2454833

rv_jd_b, rv_rv_b, rv_err_b = np.loadtxt(&#39;../../data/kic10080943b_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_b += 2400000
rv_jd_b -= 2454833

plt.scatter(rv_jd_a % period_guess / period_guess, rv_rv_a)
plt.scatter(rv_jd_b % period_guess / period_guess, rv_rv_b)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PathCollection at 0x1c275efe10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_20_1.png" src="../_images/case_studies_10080943_20_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from exoplanet.orbits import get_true_anomaly
import pymc3 as pm
import theano.tensor as tt
from maelstrom.orbit import Orbit

with pm.Model() as model:
    P = pm.Bound(pm.Normal, lower=0, upper=20)(&quot;P&quot;, mu=period_guess, sd=1,
                                     shape=1, testval=period_guess)

    asini = pm.Normal(&#39;asini&#39;, mu=np.array([a_guess, -1*a_guess]), sd=5, testval=np.array([a_guess, -1*a_guess]), shape=2)

    logs_a = pm.Normal(&quot;logs_a&quot;, mu=np.log(np.median(rv_err_a)), sd=5.0)
    logs_b = pm.Normal(&quot;logs_b&quot;, mu=np.log(np.median(rv_err_b)), sd=5.0)

    ecc = xo.distributions.UnitUniform(&quot;ecc&quot;, shape=1, testval=0.5)
    omega = xo.distributions.Angle(&quot;omega&quot;, shape=1)
    gammav = pm.Uniform(&#39;gammav&#39;, lower=-50, upper=50, testval=0.)
    phi = xo.distributions.Angle(&#39;phi&#39;, testval=0.)

    orbit_a = Orbit(period=P,
                   lighttime=asini,
                   phi=phi,
                   eccen=ecc,
                   omega=omega)
    vrad_a = orbit_a.get_radial_velocity(rv_jd_a)[:,0] + gammav
    err_a = tt.sqrt(2*rv_err_a**2 + tt.exp(2*logs_a))
    pm.Normal(&quot;obs&quot;, mu=vrad_a, sd=err_a, observed=rv_rv_a)

    vrad_b = orbit_a.get_radial_velocity(rv_jd_b)[:,1] + gammav
    err_b = tt.sqrt(2*rv_err_b**2 + tt.exp(2*logs_b))
    pm.Normal(&quot;obs_b&quot;, mu=vrad_b, sd=err_b, observed=rv_rv_b)

    t = np.linspace(rv_jd_a.min()-5, rv_jd_a.max()+5, 1000)
    fine_grid_a = orbit_a.get_radial_velocity(t) + gammav
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    map_soln = xo.optimize(start=model.test_point)
    map_soln = xo.optimize(start=map_soln, vars=[gammav])
    map_soln = xo.optimize(start=map_soln, vars=[phi])
    map_soln = xo.optimize(start=map_soln)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
optimizing logp for variables: [phi, gammav, omega, ecc, logs_b, logs_a, asini, P]
322it [00:01, 205.07it/s, logp=-2.168263e+01]
message: Desired error not necessarily achieved due to precision loss.
logp: -681450.5463788682 -&gt; -21.68262962535469
optimizing logp for variables: [gammav]
5it [00:00, 63.38it/s, logp=-2.168263e+01]
message: Optimization terminated successfully.
logp: -21.68262962535469 -&gt; -21.682629625354622
optimizing logp for variables: [phi]
3it [00:00, 42.23it/s, logp=-2.168263e+01]
message: Optimization terminated successfully.
logp: -21.682629625354622 -&gt; -21.682629625354622
optimizing logp for variables: [phi, gammav, omega, ecc, logs_b, logs_a, asini, P]
96it [00:00, 360.59it/s, logp=-2.212767e+01]
message: Desired error not necessarily achieved due to precision loss.
logp: -21.682629625354622 -&gt; -21.682629625354622
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>map_soln
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;P_interval__&#39;: array([1.19038812]),
 &#39;asini&#39;: array([ 44.9292204, -43.198366 ]),
 &#39;logs_a&#39;: array(-0.16539749),
 &#39;logs_b&#39;: array(-1.05667061),
 &#39;ecc_logodds__&#39;: array([-0.18874464]),
 &#39;omega_angle__&#39;: array([[-1.17601462],
        [ 4.31474094]]),
 &#39;gammav_interval__&#39;: array(-0.99170963),
 &#39;phi_angle__&#39;: array([-2.7313461 ,  3.54115056]),
 &#39;P&#39;: array([15.33620944]),
 &#39;ecc&#39;: array([0.45295343]),
 &#39;omega&#39;: array([-0.26609394]),
 &#39;gammav&#39;: array(-22.94254738),
 &#39;phi&#39;: array(-0.65700436)}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    fold = t % map_soln[&#39;P&#39;] / map_soln[&#39;P&#39;]
    sort = np.argsort(fold)
    plt.plot(fold[sort], xo.eval_in_model(fine_grid_a, map_soln)[:,0][sort])
    plt.plot(rv_jd_a % map_soln[&#39;P&#39;] / map_soln[&#39;P&#39;], rv_rv_a,&#39;.k&#39;)


    plt.plot(fold[sort], xo.eval_in_model(fine_grid_a, map_soln)[:,1][sort])
    plt.plot(rv_jd_b % map_soln[&#39;P&#39;] / map_soln[&#39;P&#39;], rv_rv_b,&#39;.k&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_24_0.png" src="../_images/case_studies_10080943_24_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>np.random.seed(42)
with model:
    trace = pm.sample(tune=2000, draws=2000, step=xo.get_dense_nuts_step(target_accept=0.95), start=map_soln)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [phi, gammav, omega, ecc, logs_b, logs_a, asini, P]
Sampling 2 chains: 100%|██████████| 8000/8000 [00:35&lt;00:00, 225.12draws/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>pm.summary(trace)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/danielhey/anaconda3/lib/python3.7/site-packages/pymc3/stats.py:991: FutureWarning: The join_axes-keyword is deprecated. Use .reindex or .reindex_like on the result to achieve the same functionality.
  axis=1, join_axes=[dforg.index])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>mc_error</th>
      <th>hpd_2.5</th>
      <th>hpd_97.5</th>
      <th>n_eff</th>
      <th>Rhat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>asini__0</th>
      <td>44.924885</td>
      <td>0.173424</td>
      <td>0.002319</td>
      <td>44.579209</td>
      <td>45.259325</td>
      <td>5496.583279</td>
      <td>0.999759</td>
    </tr>
    <tr>
      <th>asini__1</th>
      <td>-43.194197</td>
      <td>0.091308</td>
      <td>0.001336</td>
      <td>-43.368314</td>
      <td>-43.009628</td>
      <td>5345.994877</td>
      <td>0.999759</td>
    </tr>
    <tr>
      <th>logs_a</th>
      <td>-0.091387</td>
      <td>0.165575</td>
      <td>0.002104</td>
      <td>-0.416011</td>
      <td>0.220438</td>
      <td>4851.183366</td>
      <td>0.999881</td>
    </tr>
    <tr>
      <th>logs_b</th>
      <td>-0.852652</td>
      <td>0.230484</td>
      <td>0.003940</td>
      <td>-1.279749</td>
      <td>-0.383615</td>
      <td>3454.348539</td>
      <td>0.999813</td>
    </tr>
    <tr>
      <th>P__0</th>
      <td>15.336216</td>
      <td>0.000178</td>
      <td>0.000003</td>
      <td>15.335883</td>
      <td>15.336577</td>
      <td>3260.911780</td>
      <td>0.999853</td>
    </tr>
    <tr>
      <th>ecc__0</th>
      <td>0.453039</td>
      <td>0.001636</td>
      <td>0.000024</td>
      <td>0.450002</td>
      <td>0.456456</td>
      <td>5022.503137</td>
      <td>0.999815</td>
    </tr>
    <tr>
      <th>omega__0</th>
      <td>-0.266588</td>
      <td>0.005529</td>
      <td>0.000085</td>
      <td>-0.277859</td>
      <td>-0.256162</td>
      <td>3981.518066</td>
      <td>0.999931</td>
    </tr>
    <tr>
      <th>gammav</th>
      <td>-22.935786</td>
      <td>0.092157</td>
      <td>0.001381</td>
      <td>-23.115612</td>
      <td>-22.754384</td>
      <td>4348.433787</td>
      <td>0.999873</td>
    </tr>
    <tr>
      <th>phi</th>
      <td>-0.657458</td>
      <td>0.010379</td>
      <td>0.000190</td>
      <td>-0.678072</td>
      <td>-0.637912</td>
      <td>3111.050305</td>
      <td>0.999781</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import corner

corner.corner(pm.trace_to_dataframe(trace), smooth=0.1);
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_27_0.png" src="../_images/case_studies_10080943_27_0.png" />
</div>
</div>
</div>
<div class="section" id="Maelstrom">
<h2>Maelstrom<a class="headerlink" href="#Maelstrom" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>t, y = np.loadtxt(&#39;../data/10080943_lc.txt&#39;, usecols=(0,1)).T
ms = Maelstrom(t, y, freq=np.array([13.94758557, 15.68333011,
                                    12.45257641,
                                    12.89053954,
                                    17.30504092,
                                    14.20333404
                                   ]))

ms.setup_orbit_model(period=period_guess, eccen=0.47)
opt = ms.optimize()
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>opt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logperiod&#39;: array(2.73070653),
 &#39;t0&#39;: array(0.1754545),
 &#39;varpi_angle__&#39;: array([0.70727021, 4.41585427]),
 &#39;eccen_interval__&#39;: array(-0.02445806),
 &#39;logs&#39;: array(1.50528192),
 &#39;lighttime&#39;: array([ 53.61766022, -38.84906062, -33.42202446, -51.58519959,
        -27.89396805,  26.80916947]),
 &#39;mean_flux&#39;: array(-1.82077127e-05),
 &#39;W_hat_cos&#39;: array([ 1.05634432, -0.39108877,  0.13741391,  0.74102315,  0.31710875,
         0.12761664]),
 &#39;W_hat_sin&#39;: array([ 0.85777381, -1.18869863,  0.92644697,  0.11229363, -0.53772146,
         0.30426538]),
 &#39;period&#39;: array(15.34372403),
 &#39;varpi&#39;: array(0.15881722),
 &#39;eccen&#39;: array(0.49388591),
 &#39;tref&#39;: array(-1.11385146)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>lt = opt[&#39;lighttime&#39;]

lt_ivar = np.arange(len(ms.freq)).astype(np.int32)
chi = lt * np.sqrt(lt_ivar)
mask_lower = chi &lt; -1.0
mask_upper = chi &gt; 1.0

if np.any(mask_lower) and np.any(mask_upper):
    m1 = lt &gt;= 0
    m2 = ~m1
    lt = np.array([
        np.sum(lt_ivar[m1]*lt[m1]) / np.sum(lt_ivar[m1]),
        np.sum(lt_ivar[m2]*lt[m2]) / np.sum(lt_ivar[m2]),
    ])
    inds = 1 - m1.astype(np.int32)
else:
    inds = np.zeros(len(lt), dtype=np.int32)
    lt = np.array([np.sum(lt_ivar*lt) / np.sum(lt_ivar)])
pinned_lt = lt


nu_arr_negative = ms.freq[np.where(inds==1)]
nu_arr_positive = ms.freq[np.where(inds==0)]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>pinned_lt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 26.80916947, -37.20245805])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>nu_arr_negative
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([15.68333011, 12.45257641, 12.89053954, 17.30504092])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>pinned_lt = np.array([45, -45])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from exoplanet.orbits import get_true_anomaly
import theano.tensor as tt
from maelstrom.orbit import Orbit

with pm.Model() as model:
    logP = pm.Bound(pm.Normal,
                    lower=np.log(5),
                    upper=np.log(50))(&quot;logP&quot;, mu=np.log(opt[&#39;period&#39;]), sd=10,
                                      testval=np.log(opt[&#39;period&#39;]))
    period = pm.Deterministic(&quot;period&quot;, pm.math.exp(logP))

    phi = xo.distributions.Angle(&quot;phi&quot;)
    logs_lc = pm.Normal(&#39;logs_lc&#39;, mu=0.0001*np.log(np.std(flux)), sd=10, testval=0.)

#     a1sini = pm.Normal(&quot;a1sini&quot;, mu=pinned_lt[0], sd=15, testval=pinned_lt[0])
#     a2sini = pm.Normal(&quot;a2sini&quot;, mu=pinned_lt[1], sd=15, testval=pinned_lt[1])

    asini = pm.Uniform(&quot;a1sini&quot;, lower=-60, upper=60, testval=0., shape=len(ms.freq))

    nu = pm.Normal(&#39;nu1&#39;, mu=ms.freq, sd=0.001, testval=ms.freq, shape=len(ms.freq))
    # The baseline flux
    mean = pm.Normal(&quot;mean&quot;, mu=0.0, sd=1., testval=0.00)
    omega = xo.distributions.Angle(&quot;omega&quot;, testval=opt[&#39;varpi&#39;])
    eccen = pm.Uniform(&quot;eccen&quot;, lower=0, upper=1-1e-3, testval=opt[&#39;eccen&#39;])

    orbit = Orbit(period=period,
                  lighttime=asini,
                  omega=omega,
                  eccen=eccen,
                  phi=phi,
                  freq=nu,)

    full_lc = orbit.get_lightcurve_model(time, flux) + mean
#     # GP parameters
    logw0 = pm.Normal(&quot;logw0&quot;, mu=np.log(2*np.pi/10), sd=100,
                                                testval=np.log(2*np.pi/10))
    logpower = pm.Normal(&quot;logpower&quot;, mu=np.log(np.var(flux)), sd=100)
    logS0 = pm.Deterministic(&quot;logS0&quot;, logpower - 4 * logw0)
    kernel = xo.gp.terms.SHOTerm(log_S0=logS0, log_w0=logw0, Q=1/np.sqrt(2))
    gp = xo.gp.GP(kernel, time, tt.exp(2*logs_lc) + tt.zeros(len(time)), J=2)

    pm.Potential(&quot;obs&quot;, gp.log_likelihood(flux - full_lc))
#     pm.Normal(&#39;obs&#39;, mu=full_lc, sd=tt.exp(logs_lc), observed=flux)


# from maelstrom.utils import amplitude_spectrum
# with model:
#     full_lc = xo.eval_in_model(orbit1.get_lightcurve_model(time, flux) + orbit2.get_lightcurve_model(time, flux) + mean)
#     plt.plot(*amplitude_spectrum(time, full_lc))
#     plt.plot(*amplitude_spectrum(time, xo.eval_in_model(gp.predict())))

#     plt.plot(*amplitude_spectrum(time, flux), alpha=0.2)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    test = xo.eval_in_model(orbit.get_time_delay(time), map_params)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    all_but = [v for v in model.vars if v.name not in [&quot;logP_interval__&quot;, &quot;logasini_interval__&quot;]]
    print(all_but)

    map_params = xo.optimize(start=None, vars=[mean])
    map_params = xo.optimize(start=map_params, vars=[logs_lc])
    map_params = xo.optimize(start=map_params, vars=[logpower, logw0])
    map_params = xo.optimize(start=map_params, vars=[omega])
    map_params = xo.optimize(start=map_params, vars=[phi])
    map_params = xo.optimize(start=map_params, vars=[nu])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[asini])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[logP])
    map_params = xo.optimize(start=map_params, vars=all_but)
    map_params = xo.optimize(start=map_params, vars=[asini])
#     map_params = xo.optimize(start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[phi_angle__, logs_lc, a1sini_interval__, nu1, mean, omega_angle__, eccen_interval__, logw0, logpower]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
optimizing logp for variables: [mean]
5it [00:00, 15.82it/s, logp=-9.163383e+04]
message: Optimization terminated successfully.
logp: -91633.828619446 -&gt; -91633.82860917287
optimizing logp for variables: [logs_lc]
9it [00:00, 17.46it/s, logp=-9.141334e+04]
message: Optimization terminated successfully.
logp: -91633.82860917287 -&gt; -91413.34466631243
optimizing logp for variables: [logw0, logpower]
157it [00:08, 18.02it/s, logp=nan]
message: Desired error not necessarily achieved due to precision loss.
logp: -91413.34466631243 -&gt; nan
final logp not finite, returning initial point
this suggests that something is wrong with the model
optimizing logp for variables: [omega]
10it [00:00, 14.55it/s, logp=-9.139289e+04]
message: Optimization terminated successfully.
logp: -91413.34466631243 -&gt; -91392.88734357689
optimizing logp for variables: [phi]
10it [00:00, 12.93it/s, logp=-9.137243e+04]
message: Optimization terminated successfully.
logp: -91392.88734357689 -&gt; -91372.43002084136
optimizing logp for variables: [nu1]
69it [00:04, 16.53it/s, logp=-9.137222e+04]
message: Desired error not necessarily achieved due to precision loss.
logp: -91372.43002084136 -&gt; -91372.2151340031
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu1, a1sini, logs_lc, phi]
201it [00:15, 12.84it/s, logp=-8.778066e+04]
message: Desired error not necessarily achieved due to precision loss.
logp: -91372.2151340031 -&gt; -87780.66225683772
optimizing logp for variables: [a1sini]
7it [00:00, 14.50it/s, logp=-8.778066e+04]
message: Optimization terminated successfully.
logp: -87780.66225683772 -&gt; -87780.6622568302
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu1, a1sini, logs_lc, phi]
91it [00:07, 12.71it/s, logp=-8.778066e+04]
message: Desired error not necessarily achieved due to precision loss.
logp: -87780.6622568302 -&gt; -87780.66225682988
optimizing logp for variables: [logP]
11it [00:00, 13.02it/s, logp=-8.778014e+04]
message: Optimization terminated successfully.
logp: -87780.66225682988 -&gt; -87780.13935379263
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu1, a1sini, logs_lc, phi]
366it [00:27, 13.10it/s, logp=-8.676328e+04]
message: Desired error not necessarily achieved due to precision loss.
logp: -87780.13935379263 -&gt; -86763.278841923
optimizing logp for variables: [a1sini]
3it [00:00, 11.70it/s, logp=-8.676328e+04]
message: Optimization terminated successfully.
logp: -86763.278841923 -&gt; -86763.278841923
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>map_params
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logP_interval__&#39;: array(-0.05248899),
 &#39;phi_angle__&#39;: array([-2.47541001,  3.72455975]),
 &#39;logs_lc&#39;: array(-5.34164897),
 &#39;a1sini_interval__&#39;: array([ 2.54312226, -1.84415116, -1.65807324, -2.69856194, -1.29883947,
         1.53443407]),
 &#39;nu1&#39;: array([13.94758547, 15.68333016, 12.45257689, 12.89054031, 17.30504162,
        14.20333566]),
 &#39;mean&#39;: array(5.3961631e-05),
 &#39;omega_angle__&#39;: array([-0.1865062 ,  4.46824522]),
 &#39;eccen_interval__&#39;: array(0.14231698),
 &#39;logw0&#39;: array(4.76142513),
 &#39;logpower&#39;: array(14.48418565),
 &#39;logP&#39;: array(2.7305223),
 &#39;period&#39;: array(15.34089752),
 &#39;phi&#39;: array(-0.58658306),
 &#39;a1sini&#39;: array([ 51.25321208, -43.61267018, -40.79750263, -52.43300811,
        -34.2767524 ,  38.71849745]),
 &#39;omega&#39;: array(-0.04171615),
 &#39;eccen&#39;: array(0.5349838),
 &#39;logS0&#39;: array(-4.56151486)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>mask = map_params[&#39;a1sini&#39;] &gt; 0
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>val.T[mask]
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0.00029825, 0.00029238, 0.00028638, ..., 0.0004718 , 0.00047275,
        0.00047367],
       [0.00022531, 0.00022087, 0.00021634, ..., 0.00035642, 0.00035713,
        0.00035782]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>fig, axes = plt.subplots(2,1, figsize=[3.3333,2.06*2], constrained_layout=True)
with model:
    val = xo.eval_in_model(orbit.get_time_delay(time), map_params).T * 86400
    tt_time = time % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(tt_time)
from maelstrom.utils import unique_colors

ax = axes[1]
pos_td = val[map_params[&#39;a1sini&#39;] &gt; 0]
pos = unique_colors(len(pos_td), cmap=&#39;Oranges&#39;)[::-1]

neg_td = val[map_params[&#39;a1sini&#39;] &lt; 0]
neg = unique_colors(len(neg_td), cmap=&#39;Blues&#39;)[::-1]

for td, color in zip(pos_td, pos):
    ax.plot(tt_time[sort], td.T[sort], color=color, linewidth=0.9)

for td, color in zip(neg_td, neg):
    ax.plot(tt_time[sort], td.T[sort], color=color, linewidth=0.9)

ax.set_xlabel(&#39;Orbital phase&#39;)
ax.set_ylabel(&#39;Time delay (s)&#39;)
ax.set_xlim(0,1)

from maelstrom.utils import amplitude_spectrum
ax = axes[0]
f,a = amplitude_spectrum(time, flux)
ax.plot(f,a, linewidth=0.7, c=&#39;black&#39;)
ax.set_xlim(0,24)
ax.set_ylim(0,1.6)
ax.set_xlabel(&#39;Frequency (d$^{-1}$)&#39;)
ax.set_ylabel(&#39;Amplitude (ppt)&#39;)
ax.set_xlim(10,22)
weights = ms.get_weights(norm=False)
pos_freq = ms.freq[map_params[&#39;a1sini&#39;] &gt; 0]
pos_weight = weights[map_params[&#39;a1sini&#39;] &gt; 0]
neg_freq = ms.freq[map_params[&#39;a1sini&#39;] &lt; 0]
neg_weight = weights[map_params[&#39;a1sini&#39;] &lt; 0]

for ff, weight, color in zip(pos_freq, pos_weight, pos):
    ax.scatter(ff,weight+0.1,15,color=color, marker=&#39;v&#39;)

for ff, weight, color in zip(neg_freq, neg_weight, neg):
    ax.scatter(ff,weight+0.1,15,color=color, marker=&#39;v&#39;)

plt.savefig(overleaf_path+&#39;10080943_init_opt.pdf&#39;, dpi=300, bbox_inches=&#39;tight&#39;, pad_inches=0)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_41_0.png" src="../_images/case_studies_10080943_41_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from exoplanet.orbits import get_true_anomaly
import theano.tensor as tt

with pm.Model() as model:
    logP = pm.Bound(pm.Normal,
                    lower=np.log(5),
                    upper=np.log(50))(&quot;logP&quot;, mu=np.log(opt[&#39;period&#39;]), sd=10,
                                      testval=np.log(opt[&#39;period&#39;]))
    period = pm.Deterministic(&quot;period&quot;, pm.math.exp(logP))

    phi = xo.distributions.Angle(&quot;phi&quot;)
    logs_lc = pm.Normal(&#39;logs_lc&#39;, mu=0.0001*np.log(np.std(flux)), sd=10, testval=0.)

#     a1sini = pm.Normal(&quot;a1sini&quot;, mu=pinned_lt[0], sd=15, testval=pinned_lt[0])
#     a2sini = pm.Normal(&quot;a2sini&quot;, mu=pinned_lt[1], sd=15, testval=pinned_lt[1])

    a1sini = pm.Uniform(&quot;a1sini&quot;, lower=-60, upper=60, testval=pinned_lt[0])
    a2sini = pm.Uniform(&quot;a2sini&quot;, lower=-60, upper=60, testval=pinned_lt[1])

    nu1 = pm.Normal(&#39;nu1&#39;, mu=nu_arr_positive, sd=0.001, testval=nu_arr_positive, shape=len(nu_arr_positive))
    nu2 = pm.Normal(&#39;nu2&#39;, mu=nu_arr_negative, sd=0.001, testval=nu_arr_negative, shape=len(nu_arr_negative))
    # The baseline flux
    mean = pm.Normal(&quot;mean&quot;, mu=0.0, sd=1., testval=0.00)
    omega = xo.distributions.Angle(&quot;omega&quot;, testval=opt[&#39;varpi&#39;])
    eccen = pm.Uniform(&quot;eccen&quot;, lower=0, upper=1-1e-3, testval=opt[&#39;eccen&#39;])

    orbit1 = Orbit(period=period,
                  lighttime=a1sini,
                  omega=omega,
                  eccen=eccen,
                  phi=phi,
                  freq=nu1,
                 with_rv=True,
                 gammav=0.)

    orbit2 = Orbit(period=period,
              lighttime=a2sini,
              omega=omega,
              eccen=eccen,
              phi=phi,
              freq=nu2,
             with_rv=True,
             gammav=0.)
    full_lc = orbit1.get_lightcurve_model(time, flux) + orbit2.get_lightcurve_model(time, flux) + mean
#     # GP parameters
    logw0 = pm.Normal(&quot;logw0&quot;, mu=np.log(2*np.pi/10), sd=100,
                                                testval=np.log(2*np.pi/10))
    logpower = pm.Normal(&quot;logpower&quot;, mu=np.log(np.var(flux)), sd=100)
    logS0 = pm.Deterministic(&quot;logS0&quot;, logpower - 4 * logw0)
    kernel = xo.gp.terms.SHOTerm(log_S0=logS0, log_w0=logw0, Q=1/np.sqrt(2))
    gp = xo.gp.GP(kernel, time, tt.exp(2*logs_lc) + tt.zeros(len(time)), J=2)

    pm.Potential(&quot;obs&quot;, gp.log_likelihood(flux - full_lc))
#     pm.Normal(&#39;obs&#39;, mu=full_lc, sd=tt.exp(logs_lc), observed=flux)


# from maelstrom.utils import amplitude_spectrum`
# with model:
#     full_lc = xo.eval_in_model(orbit1.get_lightcurve_model(time, flux) + orbit2.get_lightcurve_model(time, flux) + mean)
#     plt.plot(*amplitude_spectrum(time, full_lc))
#     plt.plot(*amplitude_spectrum(time, xo.eval_in_model(gp.predict())))

#     plt.plot(*amplitude_spectrum(time, flux), alpha=0.2)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    all_but = [v for v in model.vars if v.name not in [&quot;logP_interval__&quot;, &quot;logasini_interval__&quot;]]
    print(all_but)

    map_params = xo.optimize(start=None, vars=[mean])
    map_params = xo.optimize(start=map_params, vars=[logs_lc])
    map_params = xo.optimize(start=map_params, vars=[logpower, logw0])
    map_params = xo.optimize(start=map_params, vars=[omega])
    map_params = xo.optimize(start=map_params, vars=[phi])
    map_params = xo.optimize(start=map_params, vars=[nu1, nu2])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[a1sini, a2sini])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[logP])
    map_params = xo.optimize(start=map_params, vars=all_but)
    map_params = xo.optimize(start=map_params, vars=[a1sini, a2sini])
#     map_params = xo.optimize(start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[phi_angle__, logs_lc, a1sini_interval__, a2sini_interval__, nu1, nu2, mean, omega_angle__, eccen_interval__, logw0, logpower]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
optimizing logp for variables: [mean]
5it [00:00, 14.44it/s, logp=-3.755878e+05]
message: Optimization terminated successfully.
logp: -375587.7932657327 -&gt; -375587.77287921746
optimizing logp for variables: [logs_lc]
10it [00:00, 16.14it/s, logp=-1.897250e+05]
message: Optimization terminated successfully.
logp: -375587.77287921746 -&gt; -189724.96580000242
optimizing logp for variables: [logw0, logpower]
16it [00:01, 15.87it/s, logp=-1.667492e+05]
message: Optimization terminated successfully.
logp: -189724.96580000242 -&gt; -166749.20077684356
optimizing logp for variables: [omega]
89it [00:06, 14.78it/s, logp=-1.667282e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -166749.20077684356 -&gt; -166728.17278381056
optimizing logp for variables: [phi]
13it [00:00, 13.32it/s, logp=-1.667077e+05]
message: Optimization terminated successfully.
logp: -166728.17278381056 -&gt; -166707.70834156446
optimizing logp for variables: [nu2, nu1]
63it [00:04, 14.38it/s, logp=-1.667077e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -166707.70834156446 -&gt; -166707.6972500979
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu2, nu1, a2sini, a1sini, logs_lc, phi]
142it [00:12,  8.40it/s, logp=-1.249259e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -166707.6972500979 -&gt; -124925.86999531489
optimizing logp for variables: [a2sini, a1sini]
7it [00:00, 11.72it/s, logp=-1.249259e+05]
message: Optimization terminated successfully.
logp: -124925.86999531489 -&gt; -124925.86999530705
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu2, nu1, a2sini, a1sini, logs_lc, phi]
70it [00:06, 10.69it/s, logp=-1.249259e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -124925.86999530705 -&gt; -124925.86999530692
optimizing logp for variables: [logP]
13it [00:01, 11.13it/s, logp=-1.249254e+05]
message: Optimization terminated successfully.
logp: -124925.86999530692 -&gt; -124925.43716167277
optimizing logp for variables: [logpower, logw0, eccen, omega, mean, nu2, nu1, a2sini, a1sini, logs_lc, phi]
126it [00:09, 12.83it/s, logp=-1.249250e+05]
message: Desired error not necessarily achieved due to precision loss.
logp: -124925.43716167277 -&gt; -124925.01292449453
optimizing logp for variables: [a2sini, a1sini]
3it [00:00, 11.57it/s, logp=-1.249250e+05]
message: Optimization terminated successfully.
logp: -124925.01292449453 -&gt; -124925.01292449453
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>map_params
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logP_interval__&#39;: array(-0.05248899),
 &#39;phi_angle__&#39;: array([-2.47541001,  3.72455975]),
 &#39;logs_lc&#39;: array(-5.34164897),
 &#39;a1sini_interval__&#39;: array([ 2.54312226, -1.84415116, -1.65807324, -2.69856194, -1.29883947,
         1.53443407]),
 &#39;nu1&#39;: array([13.94758547, 15.68333016, 12.45257689, 12.89054031, 17.30504162,
        14.20333566]),
 &#39;mean&#39;: array(5.3961631e-05),
 &#39;omega_angle__&#39;: array([-0.1865062 ,  4.46824522]),
 &#39;eccen_interval__&#39;: array(0.14231698),
 &#39;logw0&#39;: array(4.76142513),
 &#39;logpower&#39;: array(14.48418565),
 &#39;logP&#39;: array(2.7305223),
 &#39;period&#39;: array(15.34089752),
 &#39;phi&#39;: array(-0.58658306),
 &#39;a1sini&#39;: array([ 51.25321208, -43.61267018, -40.79750263, -52.43300811,
        -34.2767524 ,  38.71849745]),
 &#39;omega&#39;: array(-0.04171615),
 &#39;eccen&#39;: array(0.5349838),
 &#39;logS0&#39;: array(-4.56151486)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_jd_a, rv_rv_a, rv_err_a = np.loadtxt(&#39;../../data/kic10080943a_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_a += 2400000
rv_jd_a -= 2454833

rv_jd_b, rv_rv_b, rv_err_b = np.loadtxt(&#39;../../data/kic10080943b_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_b += 2400000
rv_jd_b -= 2454833
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with model:
    plt.scatter(time % 15.34003849 / 15.34003849, xo.eval_in_model(orbit1.get_radial_velocity(time), map_params))
    plt.scatter(time % 15.34003849 / 15.34003849, xo.eval_in_model(orbit1.get_time_delay(time), map_params)*86400)
    plt.scatter(rv_jd_a % 15.34003849 / 15.34003849, rv_rv_a)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_46_0.png" src="../_images/case_studies_10080943_46_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>sampler = xo.PyMC3Sampler(window=50, finish=500)
with model:
    burnin = sampler.tune(tune=1000, step_kwargs=dict(target_accept=0.9), start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains:  12%|█▏        | 36/308 [02:05&lt;15:48,  3.49s/draws]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/sampling.py</span> in <span class="ansi-cyan-fg">_mp_sample</span><span class="ansi-blue-fg">(draws, tune, step, chains, cores, chain, random_seed, start, progressbar, trace, model, use_mmap, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    998</span>             <span class="ansi-green-fg">with</span> sampler<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 999</span><span class="ansi-red-fg">                 </span><span class="ansi-green-fg">for</span> draw <span class="ansi-green-fg">in</span> sampler<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   1000</span>                     trace <span class="ansi-blue-fg">=</span> traces<span class="ansi-blue-fg">[</span>draw<span class="ansi-blue-fg">.</span>chain <span class="ansi-blue-fg">-</span> chain<span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/parallel_sampling.py</span> in <span class="ansi-cyan-fg">__iter__</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    304</span>         <span class="ansi-green-fg">while</span> self<span class="ansi-blue-fg">.</span>_active<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 305</span><span class="ansi-red-fg">             </span>draw <span class="ansi-blue-fg">=</span> ProcessAdapter<span class="ansi-blue-fg">.</span>recv_draw<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_active<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    306</span>             proc<span class="ansi-blue-fg">,</span> is_last<span class="ansi-blue-fg">,</span> draw<span class="ansi-blue-fg">,</span> tuning<span class="ansi-blue-fg">,</span> stats<span class="ansi-blue-fg">,</span> warns <span class="ansi-blue-fg">=</span> draw

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/parallel_sampling.py</span> in <span class="ansi-cyan-fg">recv_draw</span><span class="ansi-blue-fg">(processes, timeout)</span>
<span class="ansi-green-intense-fg ansi-bold">    213</span>         pipes <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>proc<span class="ansi-blue-fg">.</span>_msg_pipe <span class="ansi-green-fg">for</span> proc <span class="ansi-green-fg">in</span> processes<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">--&gt; 214</span><span class="ansi-red-fg">         </span>ready <span class="ansi-blue-fg">=</span> multiprocessing<span class="ansi-blue-fg">.</span>connection<span class="ansi-blue-fg">.</span>wait<span class="ansi-blue-fg">(</span>pipes<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    215</span>         <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> ready<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/multiprocessing/connection.py</span> in <span class="ansi-cyan-fg">wait</span><span class="ansi-blue-fg">(object_list, timeout)</span>
<span class="ansi-green-intense-fg ansi-bold">    919</span>             <span class="ansi-green-fg">while</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 920</span><span class="ansi-red-fg">                 </span>ready <span class="ansi-blue-fg">=</span> selector<span class="ansi-blue-fg">.</span>select<span class="ansi-blue-fg">(</span>timeout<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    921</span>                 <span class="ansi-green-fg">if</span> ready<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/selectors.py</span> in <span class="ansi-cyan-fg">select</span><span class="ansi-blue-fg">(self, timeout)</span>
<span class="ansi-green-intense-fg ansi-bold">    414</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 415</span><span class="ansi-red-fg">             </span>fd_event_list <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_selector<span class="ansi-blue-fg">.</span>poll<span class="ansi-blue-fg">(</span>timeout<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    416</span>         <span class="ansi-green-fg">except</span> InterruptedError<span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>:

During handling of the above exception, another exception occurred:

<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-64-e75ea9af54ba&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> sampler <span class="ansi-blue-fg">=</span> xo<span class="ansi-blue-fg">.</span>PyMC3Sampler<span class="ansi-blue-fg">(</span>window<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">50</span><span class="ansi-blue-fg">,</span> finish<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">500</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> <span class="ansi-green-fg">with</span> model<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg">     </span>burnin <span class="ansi-blue-fg">=</span> sampler<span class="ansi-blue-fg">.</span>tune<span class="ansi-blue-fg">(</span>tune<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1000</span><span class="ansi-blue-fg">,</span> step_kwargs<span class="ansi-blue-fg">=</span>dict<span class="ansi-blue-fg">(</span>target_accept<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.9</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> start<span class="ansi-blue-fg">=</span>map_params<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/exoplanet/sampling.py</span> in <span class="ansi-cyan-fg">tune</span><span class="ansi-blue-fg">(self, tune, start, step_kwargs, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    205</span>
<span class="ansi-green-intense-fg ansi-bold">    206</span>         self<span class="ansi-blue-fg">.</span>count <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg">--&gt; 207</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>warmup<span class="ansi-blue-fg">(</span>start<span class="ansi-blue-fg">=</span>start<span class="ansi-blue-fg">,</span> step_kwargs<span class="ansi-blue-fg">=</span>step_kwargs<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    208</span>         steps <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>window
<span class="ansi-green-intense-fg ansi-bold">    209</span>         trace <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/exoplanet/sampling.py</span> in <span class="ansi-cyan-fg">warmup</span><span class="ansi-blue-fg">(self, start, step_kwargs, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    138</span>             step_kwargs <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">{</span><span class="ansi-blue-fg">}</span>
<span class="ansi-green-intense-fg ansi-bold">    139</span>         step <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>get_step_for_trace<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">**</span>step_kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 140</span><span class="ansi-red-fg">         </span>self<span class="ansi-blue-fg">.</span>_extend<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>start<span class="ansi-blue-fg">,</span> start<span class="ansi-blue-fg">=</span>start<span class="ansi-blue-fg">,</span> step<span class="ansi-blue-fg">=</span>step<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    141</span>         <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_current_trace
<span class="ansi-green-intense-fg ansi-bold">    142</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/exoplanet/sampling.py</span> in <span class="ansi-cyan-fg">_extend</span><span class="ansi-blue-fg">(self, steps, start, step, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    126</span>
<span class="ansi-green-intense-fg ansi-bold">    127</span>         self._current_trace = pm.sample(
<span class="ansi-green-fg">--&gt; 128</span><span class="ansi-red-fg">             </span>start<span class="ansi-blue-fg">=</span>start<span class="ansi-blue-fg">,</span> tune<span class="ansi-blue-fg">=</span>steps<span class="ansi-blue-fg">,</span> step<span class="ansi-blue-fg">=</span>step<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs
<span class="ansi-green-intense-fg ansi-bold">    129</span>         )
<span class="ansi-green-intense-fg ansi-bold">    130</span>         self<span class="ansi-blue-fg">.</span>count <span class="ansi-blue-fg">+=</span> steps

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/sampling.py</span> in <span class="ansi-cyan-fg">sample</span><span class="ansi-blue-fg">(draws, step, init, n_init, start, trace, chain_idx, chains, cores, tune, nuts_kwargs, step_kwargs, progressbar, model, random_seed, live_plot, discard_tuned_samples, live_plot_kwargs, compute_convergence_checks, use_mmap, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    447</span>             _print_step_hierarchy<span class="ansi-blue-fg">(</span>step<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    448</span>             <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 449</span><span class="ansi-red-fg">                 </span>trace <span class="ansi-blue-fg">=</span> _mp_sample<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">**</span>sample_args<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    450</span>             <span class="ansi-green-fg">except</span> pickle<span class="ansi-blue-fg">.</span>PickleError<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    451</span>                 _log<span class="ansi-blue-fg">.</span>warning<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Could not pickle model, sampling singlethreaded.&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/sampling.py</span> in <span class="ansi-cyan-fg">_mp_sample</span><span class="ansi-blue-fg">(draws, tune, step, chains, cores, chain, random_seed, start, progressbar, trace, model, use_mmap, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1009</span>             <span class="ansi-green-fg">return</span> MultiTrace<span class="ansi-blue-fg">(</span>traces<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1010</span>         <span class="ansi-green-fg">except</span> KeyboardInterrupt<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1011</span><span class="ansi-red-fg">             </span>traces<span class="ansi-blue-fg">,</span> length <span class="ansi-blue-fg">=</span> _choose_chains<span class="ansi-blue-fg">(</span>traces<span class="ansi-blue-fg">,</span> tune<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1012</span>             <span class="ansi-green-fg">return</span> MultiTrace<span class="ansi-blue-fg">(</span>traces<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span>length<span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   1013</span>         <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/pymc3/sampling.py</span> in <span class="ansi-cyan-fg">_choose_chains</span><span class="ansi-blue-fg">(traces, tune)</span>
<span class="ansi-green-intense-fg ansi-bold">   1042</span>     lengths <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>max<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span> len<span class="ansi-blue-fg">(</span>trace<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-</span> tune<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> trace <span class="ansi-green-fg">in</span> traces<span class="ansi-blue-fg">]</span>
<span class="ansi-green-intense-fg ansi-bold">   1043</span>     <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> sum<span class="ansi-blue-fg">(</span>lengths<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1044</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">raise</span> ValueError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;Not enough samples to build a trace.&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1045</span>
<span class="ansi-green-intense-fg ansi-bold">   1046</span>     idxs <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>argsort<span class="ansi-blue-fg">(</span>lengths<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span>

<span class="ansi-red-fg">ValueError</span>: Not enough samples to build a trace.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: AstropyDeprecationWarning: Importing LombScargle from astropy.stats has been deprecated and will no longer be supported in future. Please import this class from the astropy.timeseries module instead [astropy.stats.lombscargle]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_50_1.png" src="../_images/case_studies_10080943_50_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>opt = map_params
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>opt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logP_interval__&#39;: array(-0.05304152),
 &#39;phi_angle__&#39;: array([2.84697063, 3.448891  ]),
 &#39;logs_lc&#39;: array(0.27237454),
 &#39;asini_interval__&#39;: array([ 1.19710235, -0.8571673 , -0.98050136]),
 &#39;omega_angle__&#39;: array([-0.68829479,  4.41884616]),
 &#39;mean&#39;: array(-0.04298838),
 &#39;lognu&#39;: array([2.63530639, 2.75259836, 2.52192766]),
 &#39;phase_angle__&#39;: array([[-1.75645807,  3.17034142,  1.76290606],
        [ 4.11276393,  3.15417836, -4.11000361]]),
 &#39;logamp&#39;: array([ 0.30917564,  0.22535038, -0.06669878]),
 &#39;logw0_interval__&#39;: array(9.29309804),
 &#39;logpower&#39;: array(9.04306205),
 &#39;logP&#39;: array(2.73020446),
 &#39;period&#39;: array(15.33602234),
 &#39;phi&#39;: array(0.69008215),
 &#39;asini&#39;: array([ 53.60178129, -40.41369651, -45.44153712]),
 &#39;omega&#39;: array(-0.15452177),
 &#39;nu&#39;: array([13.94758524, 15.68332996, 12.45257786]),
 &#39;phase&#39;: array([-0.40362676,  0.78795378,  2.73639752]),
 &#39;logw0&#39;: array(1.14436979),
 &#39;logS0&#39;: array(4.4655829)}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>pinned_lt = [
    53.60178129,
    -43.
]
nu_arr_positive = np.array([
    13.94758524
])
nu_arr_negative = np.array([
    15.68332996, 12.45257786
])
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>lt = opt[&#39;asini&#39;]

lt_ivar = np.arange(len(opt[&#39;nu&#39;])).astype(np.int32)
chi = lt * np.sqrt(lt_ivar)
mask_lower = chi &lt; -1.0
mask_upper = chi &gt; 1.0

if np.any(mask_lower) and np.any(mask_upper):
    m1 = lt &gt;= 0
    m2 = ~m1
    lt = np.array([
        np.sum(lt_ivar[m1]*lt[m1]) / np.sum(lt_ivar[m1]),
        np.sum(lt_ivar[m2]*lt[m2]) / np.sum(lt_ivar[m2]),
    ])
    inds = 1 - m1.astype(np.int32)
else:
    inds = np.zeros(len(lt), dtype=np.int32)
    lt = np.array([np.sum(lt_ivar*lt) / np.sum(lt_ivar)])
pinned_lt = lt

# Get frequencies for each star
nu_arr_negative = opt[&#39;nu&#39;][np.where(inds==1)]
nu_arr_positive = opt[&#39;nu&#39;][np.where(inds==0)]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from exoplanet.orbits import get_true_anomaly
import theano.tensor as tt

with pm.Model() as pb2_model:
    logP = pm.Bound(pm.Normal,
                    lower=np.log(5),
                    upper=np.log(50))(&quot;logP&quot;, mu=np.log(map_params[&#39;period&#39;]), sd=10.,
                                      testval=np.log(map_params[&#39;period&#39;]))
    period = pm.Deterministic(&quot;period&quot;, pm.math.exp(logP))
    phi = xo.distributions.Angle(&quot;phi&quot;)
    logs_lc = pm.Normal(&#39;logs_lc&#39;, mu=np.log(np.median(np.abs(np.diff(flux)))), sd=10, testval=np.log(np.median(np.abs(np.diff(flux)))))
    asini_neg = pm.Normal(&quot;asini_pos&quot;,mu=pinned_lt[0], sd=20, testval=pinned_lt[0])
    asini_pos = pm.Normal(&quot;asini_neg&quot;,mu=pinned_lt[1], sd=20, testval=pinned_lt[1])
    mean = pm.Normal(&quot;mean&quot;, mu=0.0, sd=10.0, testval=0.)

    omega = xo.distributions.Angle(&quot;omega&quot;)
    eccen = pm.Uniform(&quot;eccen&quot;, lower=0, upper=1-1e-3, testval=0.444)

    M = 2.0 * np.pi * time / period - phi
    # True anom
    f = get_true_anomaly(M, eccen + tt.zeros_like(M))
    psi = - (1 - tt.square(eccen)) * tt.sin(f+omega) / (1 + eccen*tt.cos(f))

    lognu_pos = pm.Normal(&quot;lognu_pos&quot;, mu=np.log(nu_arr_positive), sd=0.1, shape=len(nu_arr_positive))
    nu_pos = pm.Deterministic(&quot;nu_pos&quot;, tt.exp(lognu_pos))
    lognu_neg = pm.Normal(&quot;lognu_neg&quot;, mu=np.log(nu_arr_negative), sd=0.1, shape=len(nu_arr_negative))
    nu_neg = pm.Deterministic(&quot;nu_neg&quot;, tt.exp(lognu_neg))

    #  Positive
#     arg = 2. * np.pi * nu_pos[None, :] * (time[:, None] - (asini_pos / 86400.) * psi[:, None])
#     W_hat_cos_pos = pm.Normal(&quot;W_hat_cos_pos&quot;, mu=0.0, sd=100.0,shape=len(nu_arr_positive))
#     W_hat_sin_pos = pm.Normal(&quot;W_hat_sin_pos&quot;, mu=0.0, sd=100.0,shape=len(nu_arr_positive))
#     model_tensor = tt.dot(tt.cos(arg), W_hat_cos_pos[:, None]) + tt.dot(tt.sin(arg), W_hat_sin_pos[:, None])
#     lc_model = tt.squeeze(model_tensor)

#     #  Negative
#     arg = 2. * np.pi * nu_neg[None, :] * (time[:, None] - (asini_neg / 86400.) * psi[:, None])
#     W_hat_cos_neg = pm.Normal(&quot;W_hat_cos_neg&quot;, mu=0.0, sd=100.0,shape=len(nu_arr_negative))
#     W_hat_sin_neg = pm.Normal(&quot;W_hat_sin_neg&quot;, mu=0.0, sd=100.0,shape=len(nu_arr_negative))
#     model_tensor = tt.dot(tt.cos(arg), W_hat_cos_neg[:, None]) + tt.dot(tt.sin(arg), W_hat_sin_neg[:, None])
#     lc_model += tt.squeeze(model_tensor)

#     # Positive
    arg = 2. * np.pi * nu_pos * (time[:, None] - ((asini_pos) / 86400) * psi[:, None])
    D = tt.concatenate((tt.cos(arg), tt.sin(arg)), axis=-1)
    DT = D.T
    w = tt.slinalg.solve(tt.dot(DT, D), tt.dot(DT, flux))
    lc_model = tt.dot(D, w)

    # Negative
    arg = 2. * np.pi * nu_neg * (time[:, None] - ((asini_neg) / 86400) * psi[:, None])
    D = tt.concatenate((tt.cos(arg), tt.sin(arg)), axis=-1)
    DT = D.T
    w = tt.slinalg.solve(tt.dot(DT, D), tt.dot(DT, flux))
    lc_model += tt.dot(D, w)

    #GP parameters
#     logw0 = logw0 = pm.Bound(pm.Normal,
#                      lower=np.log(2*np.pi/100.0),
#                      upper=np.log(2*np.pi/1.0))(&quot;logw0&quot;, mu=np.log(2*np.pi/10), sd=10,
#                                                 testval=np.log(2*np.pi/10))
#     logpower = pm.Normal(&quot;logpower&quot;, mu=np.log(np.var(flux)), sd=10)
#     logS0 = pm.Deterministic(&quot;logS0&quot;, logpower - 4 * logw0)
#     kernel = xo.gp.terms.SHOTerm(log_S0=logS0, log_w0=logw0, Q=1/np.sqrt(2))
#     gp = xo.gp.GP(kernel, time, tt.exp(2*logs_lc) + tt.zeros(len(time)), J=2)

#     full_lc = lc_model + mean
#     gp_l = gp.log_likelihood(flux - full_lc)
#     #Weight likelihood equally with RV data
#     pm.Potential(&quot;obs&quot;, gp_l)

    full_lc = lc_model + mean
    pm.Normal(&#39;obs&#39;, mu=full_lc, sd=tt.exp(logs_lc), observed=flux)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model:
    all_but = [v for v in pb2_model.vars if v.name not in [&quot;logP_interval__&quot;]]
    print(all_but)

    map_params = xo.optimize(start=None, vars=[mean])
    map_params = xo.optimize(start=map_params, vars=[logs_lc])
#     map_params = xo.optimize(start=map_params, vars=[logpower, logw0])
#     map_params = xo.optimize(start=map_params, vars=[W_hat_cos_neg, W_hat_cos_pos, W_hat_sin_neg, W_hat_sin_pos])
    map_params = xo.optimize(start=map_params, vars=[phi])
    map_params = xo.optimize(start=map_params, vars=[lognu_pos, lognu_neg])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[asini_pos, asini_neg])
    map_params = xo.optimize(start=map_params, vars=[omega, eccen])
    map_params = xo.optimize(start=map_params, vars=all_but)

#     map_params = xo.optimize(start=map_params, vars=[logP])
    map_params = xo.optimize(start=map_params, vars=[period])
    map_params = xo.optimize(start=map_params, vars=all_but)
#     map_params = xo.optimize(start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[phi_angle__, logs_lc, asini_pos, asini_neg, mean, omega_angle__, eccen_interval__, lognu_pos, lognu_neg]
optimizing logp for variables: [&#39;mean&#39;]
message: Optimization terminated successfully.
logp: -264403.4710434688 -&gt; -264403.4703756111
optimizing logp for variables: [&#39;logs_lc&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -264403.4703756111 -&gt; -191709.93378942844
optimizing logp for variables: [&#39;phi_angle__&#39;]
message: Optimization terminated successfully.
logp: -191709.93378942844 -&gt; -191678.5181225986
optimizing logp for variables: [&#39;lognu_neg&#39;, &#39;lognu_pos&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -191678.5181225986 -&gt; -191678.50112266222
optimizing logp for variables: [&#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -191678.50112266222 -&gt; -191678.50112266184
optimizing logp for variables: [&#39;asini_pos&#39;, &#39;asini_neg&#39;]
message: Optimization terminated successfully.
logp: -191678.50112266184 -&gt; -191678.40882854586
optimizing logp for variables: [&#39;eccen_interval__&#39;, &#39;omega_angle__&#39;]
message: Optimization terminated successfully.
logp: -191678.40882854586 -&gt; -191657.93669078787
optimizing logp for variables: [&#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -191657.93669078787 -&gt; -191657.38352164047
optimizing logp for variables: [&#39;logP_interval__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -191657.38352164047 -&gt; -191657.38180303088
optimizing logp for variables: [&#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -191657.38180303088 -&gt; -191657.381638973
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>map_params
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logP_interval__&#39;: array(-0.05155323),
 &#39;phi_angle__&#39;: array([3.85765665, 2.26240394]),
 &#39;logs_lc&#39;: array(1.5181755),
 &#39;asini_pos&#39;: array(49.06203725),
 &#39;asini_neg&#39;: array(-48.97406846),
 &#39;mean&#39;: array(0.0003904),
 &#39;omega_angle__&#39;: array([-1.0650696 , -4.34345715]),
 &#39;eccen_interval__&#39;: array(-0.0423049),
 &#39;lognu_pos&#39;: array([2.63530638]),
 &#39;lognu_neg&#39;: array([2.75259833, 2.52192753]),
 &#39;logP&#39;: array(2.73106061),
 &#39;period&#39;: array(15.3491578),
 &#39;phi&#39;: array(1.04038398),
 &#39;omega&#39;: array(-2.90112501),
 &#39;eccen&#39;: array(0.48893593),
 &#39;nu_pos&#39;: array([13.94758513]),
 &#39;nu_neg&#39;: array([15.6833294 , 12.45257629])}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model:
    fold_time = time % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(fold_time)

    td_pos = xo.eval_in_model(asini_pos * psi, map_params)
    td_neg = xo.eval_in_model(asini_neg * psi, map_params)

    plt.plot(fold_time[sort], td_pos[sort])
    plt.plot(fold_time[sort], td_neg[sort])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_58_0.png" src="../_images/case_studies_10080943_58_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[103]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>sampler = xo.PyMC3Sampler(window=50, finish=500)
with pb2_model:
    burnin = sampler.tune(tune=1000, step_kwargs=dict(target_accept=0.9), start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains: 100%|██████████| 308/308 [26:45&lt;00:00, 12.61s/draws]
Sampling 4 chains: 100%|██████████| 208/208 [17:42&lt;00:00, 17.50s/draws]
Sampling 4 chains: 100%|██████████| 408/408 [38:13&lt;00:00, 13.15s/draws]
Sampling 4 chains: 100%|██████████| 808/808 [54:41&lt;00:00, 14.53s/draws]
Sampling 4 chains:  85%|████████▌ | 1962/2308 [6:23:42&lt;1:37:38, 16.93s/draws]

KeyboardInterrupt

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model:
    trace = sampler.sample(draws=1000)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Maelstrom-+-RV">
<h2>Maelstrom + RV<a class="headerlink" href="#Maelstrom-+-RV" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_jd_a, rv_rv_a, rv_err_a = np.loadtxt(&#39;data/kic10080943a_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_a += 2400000
rv_jd_a -= 2454833
rv_jd_a -= ms.time_mid

rv_jd_b, rv_rv_b, rv_err_b = np.loadtxt(&#39;data/kic10080943b_JDrv.txt&#39;, delimiter=&#39;,&#39;, usecols=(0,1,2)).T
rv_jd_b += 2400000
rv_jd_b -= 2454833
rv_jd_b -= ms.time_mid
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>plt.scatter(rv_jd_a % 15.33 / 15.33, rv_rv_a)
plt.scatter(rv_jd_b % 15.33 / 15.33, rv_rv_b)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.collections.PathCollection at 0x1c31f5fe10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_64_1.png" src="../_images/case_studies_10080943_64_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from exoplanet.orbits import get_true_anomaly
import theano.tensor as tt
import theano

rv_time_tensor_a = theano.shared(rv_jd_a)
rv_rv_tensor_a = theano.shared(rv_rv_a)

rv_time_tensor_b = theano.shared(rv_jd_b)
rv_rv_tensor_b = theano.shared(rv_rv_b)

with pm.Model() as pb2_model_RV:
    logP = pm.Bound(pm.Normal,
                    lower=np.log(5),
                    upper=np.log(50))(&quot;logP&quot;, mu=np.log(15.3356), sd=5.0,
                                      testval=np.log(15.3356))
    period = pm.Deterministic(&quot;period&quot;, pm.math.exp(logP))

    phi = xo.distributions.Angle(&quot;phi&quot;)
    logs_lc = pm.Normal(&#39;logs_lc&#39;, mu=np.log(np.std(flux)), sd=10, testval=0.)
    asini_pos = pm.Normal(&quot;asini_pos&quot;,mu=pinned_lt[0], sd=10, testval=pinned_lt[0])
    asini_neg = pm.Normal(&quot;asini_neg&quot;,mu=pinned_lt[1], sd=10, testval=pinned_lt[1])
    mean = pm.Normal(&quot;mean&quot;, mu=0.0, sd=10.0, testval=0.)
    omega = xo.distributions.Angle(&quot;omega&quot;)
    eccen = pm.Uniform(&quot;eccen&quot;, lower=0, upper=1-1e-3, testval=0.444)

    M = 2.0 * np.pi * time / period - phi
    # True anom
    f = get_true_anomaly(M, eccen + tt.zeros_like(M))
    psi = - (1 - tt.square(eccen)) * tt.sin(f+omega) / (1 + eccen*tt.cos(f))

    lognu_pos = pm.Normal(&quot;lognu_pos&quot;, mu=np.log(nu_arr_positive), sd=0.1, shape=len(nu_arr_positive))
    nu_pos = pm.Deterministic(&quot;nu_pos&quot;, tt.exp(lognu_pos))
    lognu_neg = pm.Normal(&quot;lognu_neg&quot;, mu=np.log(nu_arr_negative), sd=0.1, shape=len(nu_arr_negative))
    nu_neg = pm.Deterministic(&quot;nu_neg&quot;, tt.exp(lognu_neg))

    # Positive
    arg = 2. * np.pi * nu_pos * (time[:, None] - ((asini_pos) / 86400) * psi[:, None])
    D = tt.concatenate((tt.cos(arg), tt.sin(arg)), axis=-1)
    DT = D.T
    w = tt.slinalg.solve(tt.dot(DT, D), tt.dot(DT, flux))
    lc_model = tt.dot(D, w)

    # Negative
    arg = 2. * np.pi * nu_neg * (time[:, None] - ((asini_neg) / 86400) * psi[:, None])
    D = tt.concatenate((tt.cos(arg), tt.sin(arg)), axis=-1)
    DT = D.T
    w = tt.slinalg.solve(tt.dot(DT, D), tt.dot(DT, flux))
    lc_model += tt.dot(D, w)

    # GP parameters
#     logw0 = logw0 = pm.Bound(pm.Normal,
#                      lower=np.log(2*np.pi/100.0),
#                      upper=np.log(2*np.pi/1.0))(&quot;logw0&quot;, mu=np.log(2*np.pi/10), sd=10,
#                                                 testval=np.log(2*np.pi/10))
#     logpower = pm.Normal(&quot;logpower&quot;, mu=np.log(np.var(flux)), sd=10)
#     logS0 = pm.Deterministic(&quot;logS0&quot;, logpower - 4 * logw0)
#     kernel = xo.gp.terms.SHOTerm(log_S0=logS0, log_w0=logw0, Q=1/np.sqrt(2))
#     gp = xo.gp.GP(kernel, time, tt.exp(2*logs_lc) + tt.zeros(len(time)), J=2)

    full_lc = lc_model + mean
#     gp_l = gp.log_likelihood(flux - full_lc)
#     #Weight likelihood equally with RV data
#     pm.Potential(&quot;obs&quot;, gp_l)


    # RADIAL VELOCITIES
    logs_rv_a = pm.Normal(&#39;logs_RV_a&#39;, mu=0., sd=10)
    logs_rv_b = pm.Normal(&#39;logs_RV_b&#39;, mu=0., sd=10)
    gammav = pm.Normal(&#39;gammav&#39;, mu=0., sd=100.)

    # Positive
    rv_mean_anom = (2.0 * np.pi * rv_time_tensor_a / period - phi)
    rv_true_anom = get_true_anomaly(rv_mean_anom, eccen + tt.zeros_like(rv_mean_anom))
    rv_vrad_a = ((asini_pos / 86400) * (-2.0 * np.pi * (1 / period) * (1/tt.sqrt(1.0 - tt.square(eccen))) * (tt.cos(rv_true_anom + omega) + eccen*tt.cos(omega))))
    rv_vrad_a *= 299792.458  # c in km/s
    rv_vrad_a += gammav

    # Negative
    rv_mean_anom = (2.0 * np.pi * rv_time_tensor_b / period - phi)
    rv_true_anom = get_true_anomaly(rv_mean_anom, eccen + tt.zeros_like(rv_mean_anom))
    rv_vrad_b = ((asini_neg / 86400) * (-2.0 * np.pi * (1 / period) * (1/tt.sqrt(1.0 - tt.square(eccen))) * (tt.cos(rv_true_anom + omega) + eccen*tt.cos(omega))))
    rv_vrad_b *= 299792.458  # c in km/s
    rv_vrad_b += gammav

    pm.Normal(&quot;obs_radial_velocity_a&quot;, mu=rv_vrad_a, sd=tt.exp(logs_rv_a), observed=rv_rv_tensor_a.get_value())
    pm.Normal(&quot;obs_radial_velocity_b&quot;, mu=rv_vrad_b, sd=tt.exp(logs_rv_b), observed=rv_rv_tensor_b.get_value())
    pm.Normal(&#39;obs_lc&#39;, mu=full_lc, sd=tt.exp(logs_lc), observed=flux)
#     full_lc = lc_model + mean
#     pm.Normal(&#39;obs&#39;, mu=full_lc, sd=tt.exp(logs_lc), observed=flux)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model_RV:
    all_but = [v for v in pb2_model_RV.vars if v.name not in [&quot;logP_interval__&quot;, &quot;logasini_interval__&quot;]]
    print(all_but)

    map_params = xo.optimize(start=None, vars=[mean])
    map_params = xo.optimize(start=map_params, vars=[logs_lc, logs_rv_a])
    map_params = xo.optimize(start=map_params, vars=[gammav])
#     map_params = xo.optimize(start=map_params, vars=[phase, logamp])
    map_params = xo.optimize(start=map_params, vars=[eccen, omega])
    map_params = xo.optimize(start=map_params, vars=[phi])
    map_params = xo.optimize(start=map_params, vars=[nu_pos, nu_neg])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[asini_pos, asini_neg])
    map_params = xo.optimize(start=map_params, vars=all_but)

    map_params = xo.optimize(start=map_params, vars=[logP])
    map_params = xo.optimize(start=map_params, vars=all_but)

    plt.scatter(rv_jd_a % 15.33 / 15.33, xo.eval_in_model(rv_vrad_a, map_params))
#     map_params = xo.optimize(start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[phi_angle__, logs_lc, asini_pos, asini_neg, mean, omega_angle__, eccen_interval__, lognu_pos, lognu_neg, logs_RV_a, logs_RV_b, gammav]
optimizing logp for variables: [&#39;mean&#39;]
message: Optimization terminated successfully.
logp: -794763.9144321176 -&gt; -794763.9143904693
optimizing logp for variables: [&#39;logs_RV_a&#39;, &#39;logs_lc&#39;]
message: Optimization terminated successfully.
logp: -794763.9143904693 -&gt; -223197.9943471864
optimizing logp for variables: [&#39;gammav&#39;]
message: Optimization terminated successfully.
logp: -223197.9943471864 -&gt; -220448.23359201144
optimizing logp for variables: [&#39;omega_angle__&#39;, &#39;eccen_interval__&#39;]
message: Optimization terminated successfully.
logp: -220448.23359201144 -&gt; -196143.84383143304
optimizing logp for variables: [&#39;phi_angle__&#39;]
message: Optimization terminated successfully.
logp: -196143.84383143304 -&gt; -196013.9415108297
optimizing logp for variables: [&#39;lognu_neg&#39;, &#39;lognu_pos&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -196013.9415108297 -&gt; -196013.91453271103
optimizing logp for variables: [&#39;gammav&#39;, &#39;logs_RV_b&#39;, &#39;logs_RV_a&#39;, &#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -196013.91453271103 -&gt; -190934.58753482753
optimizing logp for variables: [&#39;asini_neg&#39;, &#39;asini_pos&#39;]
message: Optimization terminated successfully.
logp: -190934.58753482753 -&gt; -190934.58753482753
optimizing logp for variables: [&#39;gammav&#39;, &#39;logs_RV_b&#39;, &#39;logs_RV_a&#39;, &#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -190934.58753482753 -&gt; -190934.5875348261
optimizing logp for variables: [&#39;logP_interval__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -190934.5875348261 -&gt; -190932.96191555914
optimizing logp for variables: [&#39;gammav&#39;, &#39;logs_RV_b&#39;, &#39;logs_RV_a&#39;, &#39;lognu_neg&#39;, &#39;lognu_pos&#39;, &#39;eccen_interval__&#39;, &#39;omega_angle__&#39;, &#39;mean&#39;, &#39;asini_neg&#39;, &#39;asini_pos&#39;, &#39;logs_lc&#39;, &#39;phi_angle__&#39;]
message: Desired error not necessarily achieved due to precision loss.
logp: -190932.96191555914 -&gt; -190931.24357961564
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_66_1.png" src="../_images/case_studies_10080943_66_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_time_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_time_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))

with pb2_model_RV:

    fold_time = rv_time_tensor_a.get_value() % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(fold_time)
    plt.plot(fold_time[sort], xo.eval_in_model(rv_vrad_a, map_params)[sort], linewidth=0.7)
    plt.scatter(rv_jd_a % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_a)

    plt.plot(fold_time[sort], xo.eval_in_model(rv_vrad_b, map_params)[sort], linewidth=0.7)
    plt.scatter(rv_jd_b % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_b)


rv_time_tensor_a.set_value(rv_jd_a)
rv_rv_tensor_a.set_value(rv_rv_a)

rv_time_tensor_b.set_value(rv_jd_b)
rv_rv_tensor_b.set_value(rv_rv_b)

plt.xlim(0,1)
plt.xlabel(&#39;Orbital phase&#39;)
plt.ylabel(&#39;RV (km/s)&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;RV (km/s)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_67_1.png" src="../_images/case_studies_10080943_67_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_time_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_time_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))

with pb2_model_RV:
    fold_time = time % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(fold_time)

    td_pos = xo.eval_in_model(asini_pos * psi, map_params)
    td_neg = xo.eval_in_model(asini_neg * psi, map_params)

    plt.plot(fold_time[sort], td_pos[sort], c=blue)
    plt.plot(fold_time[sort], td_neg[sort], c=blue)
    plt.ylabel(&#39;Time delay (s)&#39;)

    ax2 = plt.twinx()
    fold_time = rv_time_tensor_a.get_value() % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(fold_time)
    ax2.plot(fold_time[sort], xo.eval_in_model(rv_vrad_a, map_params)[sort], linewidth=0.7, c=red)
    ax2.scatter(rv_jd_a % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_a, c=red)

    ax2.plot(fold_time[sort], xo.eval_in_model(rv_vrad_b, map_params)[sort], linewidth=0.7, c=red)
    ax2.scatter(rv_jd_b % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_b, c=red)

rv_time_tensor_a.set_value(rv_jd_a)
rv_rv_tensor_a.set_value(rv_rv_a)

rv_time_tensor_b.set_value(rv_jd_b)
rv_rv_tensor_b.set_value(rv_rv_b)

ax2.set_xlim(0,1)
plt.xlabel(&#39;Orbital phase&#39;)
ax2.set_ylabel(&#39;RV (km/s)&#39;)


</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;RV (km/s)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_68_1.png" src="../_images/case_studies_10080943_68_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>sampler = xo.PyMC3Sampler(window=200, finish=500)
with pb2_model_RV:
    burnin = sampler.tune(tune=1000, step_kwargs=dict(target_accept=0.9), start=map_params)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 2 chains: 100%|██████████| 154/154 [25:27&lt;00:00, 22.88s/draws]
Sampling 2 chains: 100%|██████████| 404/404 [1:04:06&lt;00:00, 15.68s/draws]
Sampling 2 chains: 100%|██████████| 1454/1454 [1:14:48&lt;00:00,  4.89s/draws]
Sampling 2 chains: 100%|██████████| 1004/1004 [09:20&lt;00:00,  1.36draws/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model_RV:
    trace = sampler.sample(draws=1000)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Multiprocess sampling (2 chains in 2 jobs)
NUTS: [gammav, logs_RV_b, logs_RV_a, lognu_neg, lognu_pos, eccen, omega, mean, asini_neg, asini_pos, logs_lc, phi, logP]
Sampling 2 chains: 100%|██████████| 2000/2000 [19:37&lt;00:00,  1.26draws/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>pm.summary(trace)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>mc_error</th>
      <th>hpd_2.5</th>
      <th>hpd_97.5</th>
      <th>n_eff</th>
      <th>Rhat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>logs_lc</th>
      <td>1.505374</td>
      <td>2.791965e-03</td>
      <td>5.074587e-05</td>
      <td>1.499990</td>
      <td>1.510728</td>
      <td>3196.340603</td>
      <td>0.999706</td>
    </tr>
    <tr>
      <th>asini_pos</th>
      <td>44.939928</td>
      <td>1.859542e-01</td>
      <td>3.730975e-03</td>
      <td>44.601160</td>
      <td>45.320801</td>
      <td>2232.433828</td>
      <td>1.003734</td>
    </tr>
    <tr>
      <th>asini_neg</th>
      <td>-43.164430</td>
      <td>1.459248e-01</td>
      <td>2.753235e-03</td>
      <td>-43.448645</td>
      <td>-42.882756</td>
      <td>2541.981270</td>
      <td>0.999571</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-0.000251</td>
      <td>1.773215e-02</td>
      <td>3.212764e-04</td>
      <td>-0.035832</td>
      <td>0.033215</td>
      <td>3216.097312</td>
      <td>0.999866</td>
    </tr>
    <tr>
      <th>lognu_pos__0</th>
      <td>2.635306</td>
      <td>4.902410e-07</td>
      <td>9.115598e-09</td>
      <td>2.635305</td>
      <td>2.635307</td>
      <td>2752.307907</td>
      <td>0.999522</td>
    </tr>
    <tr>
      <th>lognu_pos__1</th>
      <td>2.653477</td>
      <td>1.992874e-06</td>
      <td>3.438912e-08</td>
      <td>2.653473</td>
      <td>2.653481</td>
      <td>3053.138780</td>
      <td>0.999506</td>
    </tr>
    <tr>
      <th>lognu_neg__0</th>
      <td>2.752598</td>
      <td>4.675916e-07</td>
      <td>9.811853e-09</td>
      <td>2.752598</td>
      <td>2.752599</td>
      <td>2820.092555</td>
      <td>0.999541</td>
    </tr>
    <tr>
      <th>lognu_neg__1</th>
      <td>2.521927</td>
      <td>8.056798e-07</td>
      <td>1.400438e-08</td>
      <td>2.521926</td>
      <td>2.521929</td>
      <td>3137.253595</td>
      <td>0.999674</td>
    </tr>
    <tr>
      <th>lognu_neg__2</th>
      <td>2.556494</td>
      <td>9.788879e-07</td>
      <td>1.822999e-08</td>
      <td>2.556492</td>
      <td>2.556496</td>
      <td>3193.144832</td>
      <td>0.999993</td>
    </tr>
    <tr>
      <th>lognu_neg__3</th>
      <td>2.850998</td>
      <td>8.970943e-07</td>
      <td>1.743723e-08</td>
      <td>2.850996</td>
      <td>2.851000</td>
      <td>3013.964584</td>
      <td>0.999838</td>
    </tr>
    <tr>
      <th>logs_RV_a</th>
      <td>-0.014674</td>
      <td>1.583377e-01</td>
      <td>3.247754e-03</td>
      <td>-0.297979</td>
      <td>0.308896</td>
      <td>2265.071658</td>
      <td>0.999568</td>
    </tr>
    <tr>
      <th>logs_RV_b</th>
      <td>-0.250021</td>
      <td>1.640359e-01</td>
      <td>3.377739e-03</td>
      <td>-0.548067</td>
      <td>0.075606</td>
      <td>2332.310824</td>
      <td>1.000122</td>
    </tr>
    <tr>
      <th>gammav</th>
      <td>-22.865462</td>
      <td>1.292413e-01</td>
      <td>2.557174e-03</td>
      <td>-23.114060</td>
      <td>-22.606125</td>
      <td>2673.717894</td>
      <td>1.000419</td>
    </tr>
    <tr>
      <th>logP</th>
      <td>2.730220</td>
      <td>1.578203e-05</td>
      <td>3.652172e-07</td>
      <td>2.730187</td>
      <td>2.730249</td>
      <td>1885.452828</td>
      <td>0.999749</td>
    </tr>
    <tr>
      <th>period</th>
      <td>15.336257</td>
      <td>2.420371e-04</td>
      <td>5.601060e-06</td>
      <td>15.335761</td>
      <td>15.336705</td>
      <td>1885.455054</td>
      <td>0.999749</td>
    </tr>
    <tr>
      <th>phi</th>
      <td>0.593248</td>
      <td>8.842523e-03</td>
      <td>2.050051e-04</td>
      <td>0.576717</td>
      <td>0.611303</td>
      <td>1608.894132</td>
      <td>0.999690</td>
    </tr>
    <tr>
      <th>omega</th>
      <td>-0.269973</td>
      <td>7.671390e-03</td>
      <td>1.592557e-04</td>
      <td>-0.285719</td>
      <td>-0.255600</td>
      <td>1805.725501</td>
      <td>0.999502</td>
    </tr>
    <tr>
      <th>eccen</th>
      <td>0.453255</td>
      <td>2.300451e-03</td>
      <td>4.609963e-05</td>
      <td>0.448672</td>
      <td>0.457444</td>
      <td>2655.311820</td>
      <td>0.999500</td>
    </tr>
    <tr>
      <th>nu_pos__0</th>
      <td>13.947585</td>
      <td>6.837678e-06</td>
      <td>1.271406e-07</td>
      <td>13.947572</td>
      <td>13.947599</td>
      <td>2752.307956</td>
      <td>0.999522</td>
    </tr>
    <tr>
      <th>nu_pos__1</th>
      <td>14.203336</td>
      <td>2.830547e-05</td>
      <td>4.884402e-07</td>
      <td>14.203282</td>
      <td>14.203392</td>
      <td>3053.139932</td>
      <td>0.999506</td>
    </tr>
    <tr>
      <th>nu_neg__0</th>
      <td>15.683330</td>
      <td>7.333392e-06</td>
      <td>1.538825e-07</td>
      <td>15.683317</td>
      <td>15.683345</td>
      <td>2820.093306</td>
      <td>0.999541</td>
    </tr>
    <tr>
      <th>nu_neg__1</th>
      <td>12.452575</td>
      <td>1.003279e-05</td>
      <td>1.743905e-07</td>
      <td>12.452556</td>
      <td>12.452595</td>
      <td>3137.253841</td>
      <td>0.999674</td>
    </tr>
    <tr>
      <th>nu_neg__2</th>
      <td>12.890541</td>
      <td>1.261839e-05</td>
      <td>2.349945e-07</td>
      <td>12.890518</td>
      <td>12.890567</td>
      <td>3193.145361</td>
      <td>0.999993</td>
    </tr>
    <tr>
      <th>nu_neg__3</th>
      <td>17.305041</td>
      <td>1.552425e-05</td>
      <td>3.017520e-07</td>
      <td>17.305010</td>
      <td>17.305070</td>
      <td>3013.964816</td>
      <td>0.999838</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model_RV:
    trace = pm.load_trace(&#39;traces/10080943_rv&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>import corner

corner.corner(pm.trace_to_dataframe(trace,
                                    varnames=[&#39;asini_pos&#39;, &#39;asini_neg&#39;, &#39;gammav&#39;,&#39;period&#39;,&#39;phi&#39;,&#39;eccen&#39;,&#39;omega&#39;]),
             smooth=1,
             show_titles=True);

# plt.savefig(&#39;10080943.png&#39;, dpi=300,bbox_inches=&#39;tight&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_73_0.png" src="../_images/case_studies_10080943_73_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>from maelstrom.utils import mass_function
import astropy.units as u
rounding = 3
samples = pm.trace_to_dataframe(trace, varnames=[&#39;period&#39;, &#39;asini_pos&#39;])
mfs = mass_function(samples[&#39;period&#39;].values * u.day, samples[&#39;asini_pos&#39;].values*u.s)
#mfs = np.array(mfs)
upper, med, lower = np.percentile(mfs.value, [84.13, 50, 15.86])
print(&#39;mass_func&#39;, &#39;: &#39;, np.round(med,rounding), &#39; + &#39;, np.round(upper - med,rounding), &#39; - &#39;, np.round(med - lower,rounding))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mass_func :  0.414  +  0.005  -  0.005
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>varnames=[&#39;period&#39;, &#39;asini_pos&#39;,&#39;asini_neg&#39;, &#39;phi&#39;, &#39;eccen&#39;, &#39;omega&#39;,&#39;gammav&#39;]
rounding = 4
for varname in varnames:
    upper, med, lower = np.percentile(trace[varname], [84.13, 50, 15.86])
    print(varname, &#39;: &#39;, np.round(med,rounding), &#39; + &#39;, np.round(upper - med,rounding), &#39; - &#39;, np.round(med - lower,rounding))
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
period :  15.3363  +  0.0002  -  0.0002
asini_pos :  44.9399  +  0.1817  -  0.1792
asini_neg :  -43.1641  +  0.1465  -  0.1441
phi :  0.5933  +  0.0084  -  0.0088
eccen :  0.4532  +  0.0023  -  0.0022
omega :  -0.2701  +  0.0076  -  0.0075
gammav :  -22.8639  +  0.1282  -  0.1298
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>with pb2_model_RV:
    a = xo.eval_in_model(asini_pos * psi)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>samp
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;logP_interval__&#39;: -0.05302221292474968,
 &#39;phi_angle__&#39;: array([2.38077305, 3.50810861]),
 &#39;logs_lc&#39;: 1.503106224196015,
 &#39;asini_pos&#39;: 44.947949539218946,
 &#39;asini_neg&#39;: -43.173468198233785,
 &#39;mean&#39;: 0.003932298023283192,
 &#39;omega_angle__&#39;: array([-1.33818057,  4.99958407]),
 &#39;eccen_interval__&#39;: -0.19096305685863374,
 &#39;lognu_pos&#39;: array([2.63530587, 2.65347761]),
 &#39;lognu_neg&#39;: array([2.75259784, 2.52192862, 2.55649459, 2.85099771]),
 &#39;logs_RV_a&#39;: 0.11236832140087478,
 &#39;logs_RV_b&#39;: -0.3777195088913156,
 &#39;gammav&#39;: -22.825830993916206,
 &#39;logP&#39;: 2.7302155683426648,
 &#39;period&#39;: 15.336192661233353,
 &#39;phi&#39;: 0.5962519902387579,
 &#39;omega&#39;: -0.2615280360501543,
 &#39;eccen&#39;: 0.45195138464403606,
 &#39;nu_pos&#39;: array([13.94757791, 14.20334656]),
 &#39;nu_neg&#39;: array([15.68332182, 12.45258985, 12.89055135, 17.3050386 ])}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_time_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_time_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))

fig, axes = plt.subplots(2,1, figsize=[3.33333,2*2.06])

with pb2_model_RV:
    for samp in xo.utils.get_samples_from_trace(trace, size=300):
        taumod_pos = xo.eval_in_model(asini_pos * psi, samp)
        taumod_neg = xo.eval_in_model(asini_neg * psi, samp)
        ttime = (time) % samp[&#39;period&#39;] / samp[&#39;period&#39;]

        sort = np.argsort(ttime)

        ax = axes[0]
        ax.plot(ttime[sort], (taumod_pos - np.mean(taumod_pos))[sort], color=blue, linewidth=0.1, alpha=1, rasterized=True, zorder=1)
        ax.plot(ttime[sort], (taumod_neg - np.mean(taumod_neg))[sort], color=orange, linewidth=0.1, alpha=1, rasterized=True, zorder=1)

        ax = axes[1]
        fold_time = rv_time_tensor_a.get_value() % samp[&#39;period&#39;] / samp[&#39;period&#39;]
        sort = np.argsort(fold_time)
        ax.plot(fold_time[sort], xo.eval_in_model(rv_vrad_a, samp)[sort], linewidth=0.1, color=blue)

        ax.plot(fold_time[sort], xo.eval_in_model(rv_vrad_b, samp)[sort], linewidth=0.1, color=orange)

ax.plot(rv_jd_b % samp[&#39;period&#39;] / samp[&#39;period&#39;], rv_rv_b, &#39;.k&#39;, c=[0.91372549, 0.36862745, 0.05098039])
ax.plot(rv_jd_a % samp[&#39;period&#39;] / samp[&#39;period&#39;], rv_rv_a, &#39;.k&#39;,  c=[0.21568627, 0.52941176, 0.75424837])

axes[1].set_xlabel(&#39;Orbital phase&#39;)
axes[0].set_ylabel(&#39;Time delay (s)&#39;)
axes[1].set_ylabel(&#39;RV (km/s)&#39;)
axes[0].set_xticks([])

axes[0].set_xlim(0, 1)
axes[1].set_xlim(0, 1)

plt.subplots_adjust(hspace=0.03)
# plt.savefig(overleaf_path + &#39;10080943.png&#39;, dpi=300, bbox_inches=&#39;tight&#39;, pad_inches=0)

rv_time_tensor_a.set_value(rv_jd_a)
rv_rv_tensor_a.set_value(rv_rv_a)

rv_time_tensor_b.set_value(rv_jd_b)
rv_rv_tensor_b.set_value(rv_rv_b)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-22-279db66669bf&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> <span class="ansi-green-fg">with</span> pb2_model_RV<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span>     <span class="ansi-green-fg">for</span> samp <span class="ansi-green-fg">in</span> xo<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>get_samples_from_trace<span class="ansi-blue-fg">(</span>trace<span class="ansi-blue-fg">,</span> size<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">300</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 10</span><span class="ansi-red-fg">         </span>taumod_pos <span class="ansi-blue-fg">=</span> xo<span class="ansi-blue-fg">.</span>eval_in_model<span class="ansi-blue-fg">(</span>asini_pos <span class="ansi-blue-fg">*</span> psi<span class="ansi-blue-fg">,</span> samp<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span>         taumod_neg <span class="ansi-blue-fg">=</span> xo<span class="ansi-blue-fg">.</span>eval_in_model<span class="ansi-blue-fg">(</span>asini_neg <span class="ansi-blue-fg">*</span> psi<span class="ansi-blue-fg">,</span> samp<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>         ttime <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>time<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">%</span> samp<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;period&#39;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">/</span> samp<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#39;period&#39;</span><span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/exoplanet/utils.py</span> in <span class="ansi-cyan-fg">eval_in_model</span><span class="ansi-blue-fg">(var, point, return_func, model, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">     74</span>     <span class="ansi-green-fg">if</span> return_func<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     75</span>         <span class="ansi-green-fg">return</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> func<span class="ansi-blue-fg">,</span> args
<span class="ansi-green-fg">---&gt; 76</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     77</span>
<span class="ansi-green-intense-fg ansi-bold">     78</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/theano/compile/function_module.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    811</span>                         s.storage[0] = s.type.filter(
<span class="ansi-green-intense-fg ansi-bold">    812</span>                             arg<span class="ansi-blue-fg">,</span> strict<span class="ansi-blue-fg">=</span>s<span class="ansi-blue-fg">.</span>strict<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">--&gt; 813</span><span class="ansi-red-fg">                             allow_downcast=s.allow_downcast)
</span><span class="ansi-green-intense-fg ansi-bold">    814</span>
<span class="ansi-green-intense-fg ansi-bold">    815</span>                     <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.7/site-packages/theano/tensor/type.py</span> in <span class="ansi-cyan-fg">filter</span><span class="ansi-blue-fg">(self, data, strict, allow_downcast)</span>
<span class="ansi-green-intense-fg ansi-bold">    193</span>             <span class="ansi-green-fg">if</span> b <span class="ansi-green-fg">and</span> data<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">!=</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    194</span>                 raise TypeError(&#34;Non-unit value on shape on a broadcastable&#34;
<span class="ansi-green-fg">--&gt; 195</span><span class="ansi-red-fg">                                 &#34; dimension.&#34;, data.shape, self.broadcastable)
</span><span class="ansi-green-intense-fg ansi-bold">    196</span>             i <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-intense-fg ansi-bold">    197</span>         if (self.filter_checks_isfinite and

<span class="ansi-red-fg">TypeError</span>: (&#39;Bad input argument to theano function with name &#34;/Users/danielhey/anaconda3/lib/python3.7/site-packages/exoplanet/utils.py:46&#34; at index 8 (0-based). &#39;, &#39;Non-unit value on shape on a broadcastable dimension.&#39;, (2,), (True,))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/case_studies_10080943_78_1.png" src="../_images/case_studies_10080943_78_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>unique_colors(2, cmap=&#39;Blues&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0.67189542, 0.81437908, 0.90065359],
       [0.21568627, 0.52941176, 0.75424837]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>orange
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;#ff7f00&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>rv_time_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_a.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_time_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))
rv_rv_tensor_b.set_value(np.linspace(rv_jd_a[0], rv_jd_a[-1], 1000))

with pb2_model_RV:

    fold_time = rv_time_tensor_a.get_value() % map_params[&#39;period&#39;] / map_params[&#39;period&#39;]
    sort = np.argsort(fold_time)
    plt.plot(fold_time[sort], xo.eval_in_model(rv_vrad_a, map_params)[sort], linewidth=0.7)
    plt.scatter(rv_jd_a % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_a)

    plt.plot(fold_time[sort], xo.eval_in_model(rv_vrad_b, map_params)[sort], linewidth=0.7)
    plt.scatter(rv_jd_b % map_params[&#39;period&#39;] / map_params[&#39;period&#39;], rv_rv_b)


rv_time_tensor_a.set_value(rv_jd_a)
rv_rv_tensor_a.set_value(rv_rv_a)

rv_time_tensor_b.set_value(rv_jd_b)
rv_rv_tensor_b.set_value(rv_rv_b)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$3086663.1 \; \mathrm{km}$</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api/maelstrom.html" class="btn btn-neutral float-right" title="Maelstrom" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="6780873.html" class="btn btn-neutral float-left" title="KIC 6780873" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Daniel Hey

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>